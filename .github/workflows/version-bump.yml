name: Version Bump and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New version (e.g., 2025.12.3 or patch/minor/major)'
        required: true
        type: string

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version: '3.13'

      - name: Calculate new version
        id: version
        run: |
          CURRENT_VERSION=$(cat custom_components/idokep/manifest.json | jq -r '.version')
          INPUT_VERSION="${{ github.event.inputs.version }}"

          # If input is a full version number, use it
          if [[ $INPUT_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            NEW_VERSION=$INPUT_VERSION
          else
            # Calculate based on patch/minor/major
            IFS='.' read -r YEAR MONTH PATCH <<< "$CURRENT_VERSION"

            case $INPUT_VERSION in
              patch)
                NEW_VERSION="$YEAR.$MONTH.$((PATCH + 1))"
                ;;
              minor)
                NEW_VERSION="$YEAR.$((MONTH + 1)).0"
                ;;
              major)
                NEW_VERSION="$((YEAR + 1)).1.0"
                ;;
              *)
                echo "âŒ Invalid version input: $INPUT_VERSION"
                echo "Use format: YYYY.MM.P or patch/minor/major"
                exit 1
                ;;
            esac
          fi

          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version bump: $CURRENT_VERSION â†’ $NEW_VERSION"

      - name: Check if version exists
        run: |
          if git rev-parse "${{ steps.version.outputs.new }}" >/dev/null 2>&1; then
            echo "âŒ Version ${{ steps.version.outputs.new }} already exists as a tag!"
            exit 1
          fi

      - name: Update manifest.json
        run: |
          jq '.version = "${{ steps.version.outputs.new }}"' custom_components/idokep/manifest.json > manifest.tmp
          mv manifest.tmp custom_components/idokep/manifest.json
          echo "âœ… Updated manifest.json to version ${{ steps.version.outputs.new }}"

      - name: Install dependencies and run tests
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r test-requirements.txt
          python -m pytest tests/ -v

      - name: Validate HACS
        uses: hacs/action@main
        with:
          category: integration

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add custom_components/idokep/manifest.json
          git commit -m "Bump version to ${{ steps.version.outputs.new }}"
          git push

      - name: Create and push tag
        run: |
          git tag ${{ steps.version.outputs.new }}
          git push origin ${{ steps.version.outputs.new }}

      - name: Create release assets
        run: |
          mkdir -p dist/custom_components
          cp -r custom_components/idokep dist/custom_components/
          find dist/custom_components/idokep -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          find dist/custom_components/idokep -name "*.pyc" -delete
          find dist/custom_components/idokep -name ".pytest_cache" -type d -exec rm -rf {} + 2>/dev/null || true
          cd dist
          zip -r ../idokep-${{ steps.version.outputs.new }}.zip custom_components/idokep/

      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          {
            echo "CHANGELOG<<EOF"
            echo "## ðŸš€ What's New in v${{ steps.version.outputs.new }}"
            echo ""

            if [ -n "$LAST_TAG" ]; then
              echo "### ðŸ“‹ Changes since $LAST_TAG"
              git log --pretty=format:"- %s (%h)" "$LAST_TAG"..HEAD^ --no-merges | head -20
            else
              echo "### ðŸ“‹ Initial Release"
            fi

            echo ""
            echo "## ðŸ“¦ Installation"
            echo ""
            echo "### ðŸ  HACS (Recommended)"
            echo "1. Open HACS in Home Assistant"
            echo "2. Go to Integrations"
            echo "3. Search for 'IdÅ‘kÃ©p'"
            echo "4. Click 'Download' or 'Update'"
            echo "5. Restart Home Assistant"
            echo ""
            echo "### ðŸ“ Manual Installation"
            echo "1. Download \`idokep-${{ steps.version.outputs.new }}.zip\`"
            echo "2. Extract to \`<config>/custom_components/\`"
            echo "3. Restart Home Assistant"
            echo ""
            if [ -n "$LAST_TAG" ]; then
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$LAST_TAG...${{ steps.version.outputs.new }}"
            fi
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new }}
          name: "IdÅ‘kÃ©p v${{ steps.version.outputs.new }}"
          body: ${{ steps.changelog.outputs.CHANGELOG }}
          files: |
            idokep-${{ steps.version.outputs.new }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Success notification
        run: |
          echo "ðŸŽ‰ Release ${{ steps.version.outputs.new }} created successfully!"
          echo "ðŸ“¦ HACS will detect this update automatically"
          echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.new }}"
